╔══════════════════════════════════════════════════════════════════════════════════╗
║           EXP-014: 3-Model L1 Stacking + L2 XGB/NN Blend                       ║
║           Public LB: 0.8522 (рекорд) | OOF Macro AUC: 0.8482                   ║
╚══════════════════════════════════════════════════════════════════════════════════╝


═══════════════════════════════════════════════════════════════════════════════════
                            ИСХОДНЫЕ ДАННЫЕ
═══════════════════════════════════════════════════════════════════════════════════

  train_target.parquet ─── 750,000 клиентов × 41 таргет (target_1_1 .. target_10_1)
  train_main_features.parquet ── 750,000 × 199 (67 cat + 132 num)
  train_extra_features.parquet ─ 750,000 × 2,242 (2,241 num + customer_id)
  test_main_features.parquet ── 250,000 × 199
  test_extra_features.parquet ─ 250,000 × 2,242

  После merge по customer_id:
  ┌────────────────────────────┐     ┌────────────────────────────┐
  │ X_train: 750,000 × 2,440  │     │ X_test:  250,000 × 2,440  │
  │ y_train: 750,000 × 41     │     │ (без таргетов)             │
  │ float32, NaN до 99.9%     │     │ float32                    │
  └────────────┬───────────────┘     └─────────────┬──────────────┘
               │                                   │
               ▼                                   ▼


═══════════════════════════════════════════════════════════════════════════════════
  STEP 0.5: PER-TARGET OPTUNA (подбор гиперпараметров + feature selection)
  Цель: найти лучшие params + фичи для КАЖДОГО из 41 таргетов × 3 модели
═══════════════════════════════════════════════════════════════════════════════════

  X_train (750k × 2440)
       │
       │  np.random.choice(seed=42)
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                     СЭМПЛИРОВАНИЕ                                     │
  │  XGB/CB: 200,000 строк    LGB: 100,000 строк                         │
  │  (merge по customer_id — гарантия выравнивания!)                      │
  └───────┬─────────────────────────┬──────────────────────────┬──────────┘
          │                         │                          │
          ▼                         ▼                          ▼
  ┌───────────────────┐  ┌────────────────────┐  ┌───────────────────────┐
  │   XGBoost GPU     │  │   CatBoost GPU     │  │   LightGBM CPU       │
  │   200k, 3f, 30t   │  │   200k, 3f, 30t    │  │   100k, 3f, 20t      │
  │   ~202 мин        │  │   ~684 мин         │  │   ~216 мин           │
  ├───────────────────┤  ├────────────────────┤  ├───────────────────────┤
  │                   │  │                    │  │                       │
  │ Для КАЖДОГО из 41 │  │ Для КАЖДОГО из 41  │  │ Для КАЖДОГО из 41    │
  │ таргетов:         │  │ таргетов:          │  │ таргетов:            │
  │                   │  │                    │  │                       │
  │ 1. Feature Select │  │ 1. Feature Select  │  │ 1. Feature Select    │
  │    XGB gain 85%   │  │    CB PredValues    │  │    LGB gain 85%      │
  │    2440 → 31-534  │  │    2440 → 25-194   │  │    2440 → 9-631      │
  │                   │  │                    │  │                       │
  │ 2. Optuna 30 tr.  │  │ 2. Optuna 30 tr.   │  │ 2. Optuna 20 tr.    │
  │    xgb.cv + prune │  │    3-fold CV       │  │    LGB + pruning      │
  │    1000 rounds    │  │    2000 iter       │  │    1000 rounds        │
  │    early_stop=50  │  │    early_stop=50   │  │    early_stop=50      │
  │                   │  │                    │  │                       │
  │ Search space:     │  │ Search space:      │  │ Search space:        │
  │  depth 3-10       │  │  depth 4-10        │  │  num_leaves 16-255   │
  │  lr 0.005-0.1     │  │  lr 0.005-0.1      │  │  lr 0.005-0.1        │
  │  colsample 0.05-1 │  │  l2_leaf 0.01-100  │  │  feat_frac 0.05-1.0  │
  │  subsample 0.5-1  │  │  subsample 0.5-1   │  │  bagging 0.4-1.0     │
  │  lambda 1e-3-25   │  │  border 32-254     │  │  lambda 1e-8-100     │
  │  gamma 1e-8-1     │  │  min_data 1-100    │  │  min_child 5-2500    │
  │  max_bin 128-512  │  │  rand_str 0-20     │  │  max_bin 63-511      │
  │                   │  │                    │  │                       │
  │ Mean AUC: 0.8278  │  │ Mean AUC: 0.8211   │  │ Mean AUC: 0.8080    │
  └─────────┬─────────┘  └──────────┬─────────┘  └───────────┬─────────┘
            │                       │                         │
            ▼                       ▼                         ▼
  ┌───────────────────┐  ┌────────────────────┐  ┌───────────────────────┐
  │ АРТЕФАКТЫ:        │  │ АРТЕФАКТЫ:         │  │ АРТЕФАКТЫ:           │
  │ step05_xgb/       │  │ step05_cb/         │  │ step05_lgb/          │
  │  xgb_best_params  │  │  cb_best_params    │  │  lgb_best_params     │
  │   .json (41 key)  │  │   .json (41 key)   │  │   .json (41 key)    │
  │  xgb_best_features│  │  cb_best_features  │  │  lgb_best_features   │
  │   .json (41 key)  │  │   .json (41 key)   │  │   .json (41 key)    │
  └─────────┬─────────┘  └──────────┬─────────┘  └───────────┬─────────┘
            │                       │                         │
            └───────────────────────┼─────────────────────────┘
                                    │
                                    ▼

═══════════════════════════════════════════════════════════════════════════════════
  STEP 1: L1 OOF (Out-of-Fold predictions, 750k полный train)
  Цель: получить "честные" предсказания для КАЖДОГО клиента от 3 моделей
  Время: ~397 мин
═══════════════════════════════════════════════════════════════════════════════════

  X_train (750k × 2440) + y_train (750k × 41) + X_test (250k × 2440)
       │                                              │
       │  StratifiedKFold(n_splits=5, seed=42)        │
       ▼                                              │
  ┌───────────────────────────────────────────────┐   │
  │  Для КАЖДОГО из 41 таргетов:                  │   │
  │                                               │   │
  │  ┌─── Fold 1 ───┐  train(600k) → val(150k)   │   │
  │  │ Fold 2       │  train(600k) → val(150k)   │   │
  │  │ Fold 3       │  train(600k) → val(150k)   │   │
  │  │ Fold 4       │  train(600k) → val(150k)   │   │
  │  └─ Fold 5 ─────┘  train(600k) → val(150k)   │   │
  │                                               │   │
  │  Каждый fold × 3 модели:                      │   │
  │  ┌──────────────────────────────────────────┐ │   │
  │  │ XGBoost GPU                              │ │   │
  │  │  params: из step05_xgb (per-target)      │ │   │
  │  │  feats:  из step05_xgb (31-534 per tgt)  │ │   │
  │  │  device='cuda', 2000 rounds, ES=50       │ │   │
  │  │  → predict(val) → oof_xgb[val_idx]       │─│───│──→ predict(test) / 5
  │  ├──────────────────────────────────────────┤ │   │
  │  │ CatBoost GPU                             │ │   │
  │  │  params: из step05_cb (per-target)       │ │   │
  │  │  feats:  из step05_cb (25-194 per tgt)   │ │   │
  │  │  task_type='GPU', Poisson, 2000 iter     │ │   │
  │  │  → predict_proba(val)[:,1] → oof_cb      │─│───│──→ predict_proba(test)[:,1] / 5
  │  ├──────────────────────────────────────────┤ │   │
  │  │ LightGBM CPU                             │ │   │
  │  │  params: из step05_lgb (per-target)      │ │   │
  │  │  feats:  из step05_lgb (9-631 per tgt)   │ │   │
  │  │  n_jobs=-1, 2000 rounds, ES=50           │ │   │
  │  │  → predict(val) → oof_lgb[val_idx]       │─│───│──→ predict(test) / 5
  │  └──────────────────────────────────────────┘ │   │
  │                                               │   │
  │  OOF Macro AUC (среднее по 41 таргету):       │   │
  │    XGBoost:  0.8404 (лидер 38/41 таргетов)    │   │
  │    CatBoost: 0.8295                           │   │
  │    LightGBM: 0.8272                           │   │
  └───────────────────────────────────────────────┘   │
            │                                         │
            ▼                                         ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │ АРТЕФАКТЫ: l1_oof/                                                 │
  │                                                                    │
  │  OOF (train, каждый клиент предсказан моделью которая его НЕ видела)│
  │  ┌────────────────┐ ┌───────────────┐ ┌────────────────┐           │
  │  │ oof_xgb.npy    │ │ oof_cb.npy    │ │ oof_lgb.npy    │           │
  │  │ 750,000 × 41   │ │ 750,000 × 41  │ │ 750,000 × 41   │           │
  │  │ float32        │ │ float32       │ │ float32        │           │
  │  └────────────────┘ └───────────────┘ └────────────────┘           │
  │                                                                    │
  │  TEST (среднее 5 фолдов)                                           │
  │  ┌────────────────┐ ┌───────────────┐ ┌────────────────┐           │
  │  │ test_xgb.npy   │ │ test_cb.npy   │ │ test_lgb.npy   │           │
  │  │ 250,000 × 41   │ │ 250,000 × 41  │ │ 250,000 × 41   │           │
  │  │ float32        │ │ float32       │ │ float32        │           │
  │  └────────────────┘ └───────────────┘ └────────────────┘           │
  │                                                                    │
  │  results_log.json — AUC по каждому таргету × 3 модели              │
  └───────────────────────────────┬────────────────────────────────────┘
                                  │
                                  ▼

═══════════════════════════════════════════════════════════════════════════════════
  СБОРКА L2 МАТРИЦЫ (из L1 OOF → фичи для L2)
═══════════════════════════════════════════════════════════════════════════════════

  oof_xgb (750k×41) + oof_cb (750k×41) + oof_lgb (750k×41)
       │                    │                    │
       │    hstack          │                    │
       ├────────────────────┼────────────────────┘
       │                    │
       ▼                    ▼
  ┌──────────────┐   ┌────────────────────────────────────────┐
  │ 123 OOF фичи │   │ 82 мета-фичи:                         │
  │ (41×3 модели) │   │  mean(xgb, cb, lgb) per target → 41   │
  │              │   │  std(xgb, cb, lgb)  per target → 41   │
  └──────┬───────┘   └────────────────┬───────────────────────┘
         │                            │
         └────────────┬───────────────┘
                      │  hstack
                      ▼
            ┌──────────────────────┐         ┌──────────────────────┐
            │ X_l2_train           │         │ X_l2_test            │
            │ 750,000 × 205       │         │ 250,000 × 205        │
            │ [0..40]   = xgb OOF │         │ [0..40]   = xgb test │
            │ [41..81]  = cb  OOF │         │ [41..81]  = cb  test │
            │ [82..122] = lgb OOF │         │ [82..122] = lgb test │
            │ [123..163]= mean    │         │ [123..163]= mean     │
            │ [164..204]= std     │         │ [164..204]= std      │
            └──────────┬──────────┘         └──────────┬───────────┘
                       │                               │
                       ▼                               ▼


═══════════════════════════════════════════════════════════════════════════════════
  STEP 2a: L2 XGBoost (per-target Optuna + OOF)
  Время: Optuna ~141 мин + OOF ~10.5 мин
═══════════════════════════════════════════════════════════════════════════════════

  X_l2_train (750k × 205) + y_train (750k × 41)
       │
       │ Для КАЖДОГО из 41 таргетов:
       ▼
  ┌───────────────────────────────────────────────────────────────────┐
  │  1. OPTUNA (15 trials, 5-fold CV)                                │
  │     Search space:                                                │
  │       depth: 2-4 (мелкие деревья, L2 не должен быть сложным!)    │
  │       lr: 0.01-0.3                                               │
  │       colsample: 0.1-0.6                                         │
  │       subsample: 0.6-1.0                                         │
  │       lambda: 0.1-50                                             │
  │       alpha: 0.001-10                                            │
  │       min_child_weight: 1-50                                     │
  │     Типичный результат: depth=4, lr=0.03, colsample=0.15-0.35   │
  │                                                                  │
  │  2. OOF PREDICTIONS (5-fold, те же фолды)                        │
  │     XGBoost GPU, 500 rounds, early_stop=30                       │
  │     Каждый fold:                                                 │
  │       train(600k) → predict(val 150k) → oof_l2_xgb[val_idx]     │
  │       train(600k) → predict(test 250k) / 5 → test_l2_xgb        │
  │                                                                  │
  │  OOF Macro AUC: 0.8457                                           │
  └───────────────────────────────────┬───────────────────────────────┘
                                      │
                                      ▼
                          ┌──────────────────────────┐
                          │ АРТЕФАКТЫ: l2_stacking/   │
                          │                          │
                          │ l2_xgb_best_params.json  │
                          │  (41 key, per-target)    │
                          │                          │
                          │ oof_l2_xgb.npy           │
                          │  750,000 × 41, float32   │
                          │                          │
                          │ test_l2_xgb.npy          │
                          │  250,000 × 41, float32   │
                          └──────────┬───────────────┘
                                     │
                                     ▼

═══════════════════════════════════════════════════════════════════════════════════
  STEP 2b: L2 Neural Network v2 (PyTorch)
  Время: ~23 мин
═══════════════════════════════════════════════════════════════════════════════════

  X_l2_train (750k × 205) ──→ StandardScaler ──→ X_scaled (range ~[-4, +4])
       │                        (НЕ logit! logit = range [-14, +283] = смерть)
       ▼
  ┌───────────────────────────────────────────────────────────────────┐
  │  АРХИТЕКТУРА L2NetV2:                                            │
  │                                                                  │
  │  Input (205)                                                     │
  │    │                                                             │
  │    ▼                                                             │
  │  LayerNorm(205)     ← нормализация входа                        │
  │    │                                                             │
  │    ▼                                                             │
  │  ┌─────────────────────────────────────────────────────────┐     │
  │  │ Block 1:                                                │     │
  │  │   Linear(205 → 512) → LayerNorm(512) → SiLU            │     │
  │  │   → Dropout(0.30)                                       │     │
  │  │   выход: h1 (512)                                       │     │
  │  └──────────────┬─────────────────────────────┬────────────┘     │
  │                 │                             │                  │
  │                 ▼                             │ skip_proj         │
  │  ┌──────────────────────────────────┐         │ Linear(512→256)  │
  │  │ Block 2:                         │         │ × 0.5             │
  │  │   Linear(512 → 256)             │         │                  │
  │  │   → LayerNorm(256)              │         │                  │
  │  │   → ADD(skip_proj(h1) × 0.5)   │ ◄───────┘  RESIDUAL        │
  │  │   → SiLU → Dropout(0.25)       │                            │
  │  │   выход: h2 (256)               │                            │
  │  └──────────────┬──────────────────┘                            │
  │                 │                                                │
  │                 ▼                                                │
  │  ┌──────────────────────────────────┐                            │
  │  │ Block 3:                         │                            │
  │  │   Linear(256 → 128)             │                            │
  │  │   → LayerNorm(128) → SiLU       │                            │
  │  │   → Dropout(0.20)               │                            │
  │  │   выход: h3 (128)               │                            │
  │  └──────────────┬──────────────────┘                            │
  │                 │                                                │
  │                 ▼                                                │
  │  ┌──────────────────────────────────┐                            │
  │  │ Classifier:                      │                            │
  │  │   Linear(128 → 41)              │                            │
  │  │   → (logits, BCEWithLogitsLoss)  │                            │
  │  │   → sigmoid → probabilities     │                            │
  │  └──────────────────────────────────┘                            │
  │                                                                  │
  │  TRAINING:                                                       │
  │    Optimizer:  AdamW(lr=0.001, weight_decay=1e-5)                │
  │    Scheduler:  OneCycleLR(max_lr=0.001, pct_start=0.3)          │
  │    Loss:       BCEWithLogitsLoss (без label smoothing!)          │
  │    Clipping:   grad_norm max=1.0                                 │
  │    Batch:      512                                               │
  │    Epochs:     60 (v3, рекорд) / 30 (v2)                         │
  │    Patience:   15 (v3) / 10 (v2)                                 │
  │                                                                  │
  │  5-FOLD OOF (StratifiedKFold, seed=42, stratify=target_1_1):     │
  │    Fold 1: AUC=0.8426, best_ep=50, stopped=60, time=543s        │
  │    Fold 2: AUC=0.8400, best_ep=47, stopped=60, time=541s        │
  │    Fold 3: AUC=0.8440, best_ep=44, stopped=59, time=532s        │
  │    Fold 4: AUC=0.8416, best_ep=47, stopped=60, time=542s        │
  │    Fold 5: AUC=0.8408, best_ep=45, stopped=60, time=541s        │
  │    test_pred = mean(5 fold predictions), время: 45 мин           │
  │                                                                  │
  │  OOF Macro AUC: 0.8415 (v3, рекорд LB 0.8522)                  │
  └───────────────────────────────────┬───────────────────────────────┘
                                      │
                                      ▼
                          ┌──────────────────────────┐
                          │ АРТЕФАКТЫ: l2_stacking/   │
                          │                          │
                          │ oof_l2_nn_v2.npy         │
                          │  750,000 × 41, float32   │
                          │                          │
                          │ test_l2_nn_v2.npy        │
                          │  250,000 × 41, float32   │
                          └──────────┬───────────────┘
                                     │
                                     ▼

═══════════════════════════════════════════════════════════════════════════════════
  FINAL: BLEND + SUBMISSION
═══════════════════════════════════════════════════════════════════════════════════

  oof_l2_xgb (750k×41, AUC=0.8457)      oof_l2_nn (750k×41, AUC=0.8414)
       │                                      │
       │         α = 0.60                      │  (1-α) = 0.40
       │                                      │
       ▼                                      ▼
  ┌────────────────────────────────────────────────────────────────┐
  │                                                                │
  │   blend_oof  = 0.60 × oof_l2_xgb  + 0.40 × oof_l2_nn         │
  │   blend_test = 0.60 × test_l2_xgb + 0.40 × test_l2_nn        │
  │                                                                │
  │   OOF Macro AUC: 0.8482                                       │
  │                                                                │
  │   Тест пропорций (v3):                                         │
  │     100/0  → 0.8457          65/35 → 0.8481                   │
  │     90/10  → 0.8468          60/40 → 0.8482 ← BEST            │
  │     85/15  → 0.8473          55/45 → 0.8481                   │
  │     80/20  → 0.8476          50/50 → 0.8480                   │
  │     75/25  → 0.8478                                            │
  │     70/30  → 0.8480                                            │
  │                                                                │
  └────────────────────────────┬───────────────────────────────────┘
                               │
                               ▼
  ┌────────────────────────────────────────────────────────────────┐
  │  SUBMISSION                                                    │
  │                                                                │
  │  blend_test.astype(np.float64)  ← ОБЯЗАТЕЛЬНО float64!        │
  │                                                                │
  │  Колонки: customer_id + predict_1_1, predict_2_1, ...         │
  │           (predict_*, НЕ target_*!)                            │
  │                                                                │
  │  Shape: 250,000 × 42                                           │
  │  Format: .parquet                                              │
  │                                                                │
  │  → sub_l2_blend_v3.parquet                                     │
  │  → Upload → Public LB: 0.8522                                 │
  └────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════
  ПОЛНАЯ КАРТА АРТЕФАКТОВ
═══════════════════════════════════════════════════════════════════════════════════

  artifacts/
  │
  ├── step05_xgb/                          Step 0.5 XGBoost
  │   ├── xgb_best_params.json             41 key → {max_depth, lr, colsample, ...}
  │   └── xgb_best_features.json           41 key → [feat1, feat2, ...] (31-534)
  │
  ├── step05_cb/                           Step 0.5 CatBoost
  │   ├── cb_best_params.json              41 key → {depth, lr, l2_leaf_reg, ...}
  │   └── cb_best_features.json            41 key → [feat1, feat2, ...] (25-194)
  │
  ├── step05_lgb/                          Step 0.5 LightGBM
  │   ├── lgb_best_params.json             41 key → {num_leaves, lr, lambda, ...}
  │   └── lgb_best_features.json           41 key → [feat1, feat2, ...] (9-631)
  │
  ├── l1_oof/                              Step 1 L1 OOF
  │   ├── oof_xgb.npy                     (750000, 41) float32 — OOF train
  │   ├── oof_cb.npy                      (750000, 41) float32
  │   ├── oof_lgb.npy                     (750000, 41) float32
  │   ├── test_xgb.npy                    (250000, 41) float32 — test mean(5 folds)
  │   ├── test_cb.npy                     (250000, 41) float32
  │   ├── test_lgb.npy                    (250000, 41) float32
  │   └── results_log.json                AUC per target × 3 models
  │
  └── l2_stacking/                         Step 2 L2
      ├── l2_xgb_best_params.json          41 key → {max_depth, lr, ...}
      ├── oof_l2_xgb.npy                  (750000, 41) float32
      ├── test_l2_xgb.npy                 (250000, 41) float32
      ├── oof_l2_nn_v2.npy                (750000, 41) float32  — 30 ep, OOF 0.8414
      ├── test_l2_nn_v2.npy               (250000, 41) float32
      ├── oof_l2_nn_v3.npy                (750000, 41) float32  — 60 ep, OOF 0.8415, LB 0.8522
      └── test_l2_nn_v3.npy               (250000, 41) float32

  Итого: 6 JSON + 10 NPY + 1 results_log = 17 файлов


═══════════════════════════════════════════════════════════════════════════════════
  КЛЮЧЕВЫЕ ПРАВИЛА (НАВСЕГДА)
═══════════════════════════════════════════════════════════════════════════════════

  1. ВЫРАВНИВАНИЕ: всегда merge/loc по customer_id (np.random.choice ломает порядок)
  2. SUBMISSION:    колонки predict_*_* (НЕ target_!), тип float64 (НЕ float32!)
  3. GPU:           XGBoost device='cuda', CatBoost task_type='GPU', LGB = CPU
  4. CATBOOST GPU:  bootstrap_type='Poisson' (Bayesian не на GPU)
  5. КАЖДАЯ МОДЕЛЬ: СВОЙ feature selection + СВОЯ Optuna (чужие фичи = вред)
  6. L2 ДЕРЕВЬЯ:    depth 2-4 (НЕ глубокие! это стекинг, не L1)
  7. NN L2:         LayerNorm, StandardScaler, lr=0.001, batch=512, SiLU
  8. БЛЕНД:         60% XGB + 40% NN (подтверждено OOF и LB)
